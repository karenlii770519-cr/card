<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŒ‡è¦å¦³ Just ForYou | ç·šä¸Šé ç´„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --brand-wine: #8F2C2F; --brand-pink: #D86B76; --bg-gray: #F3F4F6; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-gray); }
        .selected-card { border-color: #ea5548 !important; background-color: white !important; transform: scale(1.02); }
        .btn-disabled { background-color: #d1d5db !important; color: #9ca3af !important; cursor: not-allowed !important; pointer-events: none; }
        .hidden { display: none !important; }
        /* éš±è—å·è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* åŸç”Ÿ CSS Loading æ¨£å¼ */
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease; }
        .spinner { width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #8F2C2F; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-out { opacity: 0; pointer-events: none; }
    </style>
</head>
<body class="pb-12">

    <div id="loading">
        <div class="spinner"></div>
        <p style="color: #8F2C2F; font-weight: bold; font-family: sans-serif;">ç³»çµ±è¼‰å…¥ä¸­...</p>
    </div>

    <div id="app" class="max-w-md mx-auto min-h-screen relative hidden flex flex-col">
        
        <div class="w-full">
            <img src="https://karenlii770519-cr.github.io/card/top.jpg" 
                 alt="Banner" 
                 class="w-full h-auto">
        </div>
        
        <div class="bg-[#FFF8F0] text-gray-600 text-xs px-4 py-3 border-b border-orange-100 text-center leading-relaxed">
            <p class="font-bold text-[#ea5548] mb-1">ã€çºŒä½œå„ªæƒ ã€‘</p>
            <p>æœ¬åº—çºŒä½œ 3 é€±å…§å¸ç”²å…è²»</p>
            <p>è«‹ç›´æ¥é¸æ“‡ã€æ‰‹éƒ¨ã€‘æˆ–ã€è¶³éƒ¨ã€‘åˆ†é¡é …ç›®é ç´„</p>
            <div class="mt-2 pt-2 border-t border-orange-100 text-[11px] text-gray-400">
                âš ï¸ æ³¨æ„ï¼šæŒ‡ç”²ç‹€æ³ç‚ºã€Œè¶…é 3 é€±ã€æˆ–ã€Œéæœ¬åº—çºŒä½œã€ï¼Œè«‹å‹™å¿…é¸æ“‡ã€å¸ç”²ã€‘é …ç›®é ç´„ã€‚
            </div>
        </div>

        <header class="p-6 flex justify-between items-center bg-white shadow-sm mb-4 sticky top-0 z-10">
            <div><h1 class="text-xl font-bold text-gray-700">æŒ‡è¦å¦³ <span class="text-[#ea5548] text-sm block">Just ForYou Nail salon</span></h1></div>
            <div class="flex items-center gap-3">
                <button onclick="showMyBookings()" class="text-xs bg-gray-100 px-3 py-2 rounded-full font-bold text-gray-600 hover:bg-gray-200">ğŸ“‹ æˆ‘çš„é ç´„</button>
                <div class="flex items-center gap-2">
                    <img id="userImg" src="https://via.placeholder.com/40" class="w-8 h-8 rounded-full border border-gray-200">
                    <span id="userName" class="text-xs font-bold text-gray-500">Guest</span>
                </div>
            </div>
        </header>

        <div id="mainView">
            <div class="px-6 mb-6">
                <div class="w-full bg-gray-200 h-1.5 rounded-full overflow-hidden">
                    <div id="progressBar" class="h-full bg-[#ea5548] transition-all duration-500" style="width: 20%"></div>
                </div>
            </div>

            <main class="px-4">
                <div id="step1" class="step-content">
                    <h2 class="text-lg font-bold text-gray-700 mb-4 border-l-4 border-[#8F2C2F] pl-3">é¸æ“‡é …ç›®</h2>
                    <div id="categoryList" class="grid grid-cols-2 gap-3 pb-8"></div>
                </div>

                <div id="step2" class="step-content hidden">
                    <h2 class="text-lg font-bold text-gray-700 mb-4 border-l-4 border-[#8F2C2F] pl-3">é¸æ“‡æ¬¾å¼</h2>
                    <div id="serviceList" class="space-y-3 pb-8"></div>
                    <button onclick="changeStep(1)" class="w-full mt-4 py-3 bg-white text-gray-400 font-bold border rounded-xl">å›ä¸Šä¸€æ­¥</button>
                </div>

                <div id="step3" class="step-content hidden">
                    <h2 class="text-lg font-bold text-gray-700 mb-4 border-l-4 border-[#8F2C2F] pl-3">é¸æ“‡è€å¸«</h2>
                    <div id="stylistList" class="space-y-3"></div>
                    <div class="flex gap-3 mt-6">
                        <button onclick="changeStep(2)" class="w-1/3 py-3 bg-white text-gray-400 font-bold border rounded-xl">ä¸Šä¸€æ­¥</button>
                        <button onclick="changeStep(4)" class="flex-1 py-3 bg-[#ea5548] text-white font-bold rounded-xl shadow-lg">ä¸‹ä¸€æ­¥</button>
                    </div>
                </div>

                <div id="step4" class="step-content hidden">
                    <h2 class="text-lg font-bold text-gray-700 mb-4 border-l-4 border-[#8F2C2F] pl-3">é ç´„æ™‚é–“</h2>
                    <div class="bg-white p-4 rounded-2xl shadow-sm mb-4">
                        <label class="block text-xs font-bold text-gray-400 mb-2">æ—¥æœŸ</label>
                        <input type="date" id="dateInput" class="w-full min-w-0 appearance-none bg-gray-50 px-3 py-3 rounded-xl font-bold text-gray-700 text-base outline-none border focus:border-[#ea5548]">
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-xs font-bold text-gray-400">æ™‚æ®µ <span id="durationHint" class="text-[#ea5548]"></span></label>
                            <span id="timeLoading" class="text-xs text-[#ea5548] font-bold hidden">æŸ¥è©¢ä¸­...</span>
                        </div>
                        <div id="timeSlots" class="grid grid-cols-3 gap-2"></div>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-[#ea5548]/20">
                        <label class="block text-xs font-bold text-gray-400 mb-2">é›»è©±</label>
                        <input type="tel" id="userPhone" placeholder="09xx..." class="w-full bg-gray-50 p-3 rounded-xl font-bold text-gray-700 outline-none border">
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button onclick="changeStep(3)" class="w-1/3 py-3 bg-white text-gray-400 font-bold border rounded-xl">ä¸Šä¸€æ­¥</button>
                        <button onclick="validateAndNext()" class="flex-1 py-3 bg-[#ea5548] text-white font-bold rounded-xl shadow-lg">ä¸‹ä¸€æ­¥</button>
                    </div>
                </div>

                <div id="step5" class="step-content hidden">
                    <h2 class="text-lg font-bold text-gray-700 mb-4 border-l-4 border-[#8F2C2F] pl-3">ç¢ºèªè³‡è¨Š</h2>
                    <div class="bg-white p-6 rounded-2xl shadow-sm space-y-4 text-sm">
                        <div class="flex justify-between border-b pb-2"><span class="text-gray-400">é ç´„äºº</span><span id="confirmName" class="font-bold"></span></div>
                        <div class="flex justify-between border-b pb-2"><span class="text-gray-400">è€å¸«</span><span id="confirmStylist" class="font-bold"></span></div>
                        <div class="flex justify-between border-b pb-2"><span class="text-gray-400">é …ç›®</span><span id="confirmService" class="font-bold"></span></div>
                        <div class="flex justify-between border-b pb-2"><span class="text-gray-400">æ™‚é•·</span><span id="confirmDuration" class="font-bold text-[#8F2C2F]"></span></div>
                        <div class="flex justify-between"><span class="text-gray-400">æ™‚é–“</span><span id="confirmDateTime" class="font-bold text-[#ea5548]"></span></div>
                    </div>
                    <button onclick="submitBooking()" class="w-full mt-6 py-4 bg-[#ea5548] text-white font-bold rounded-2xl shadow-xl">ç¢ºèªé€å‡º</button>
                    <button onclick="changeStep(4)" class="w-full mt-3 py-3 text-gray-400 font-bold">è¿”å›ä¿®æ”¹</button>
                </div>

                <div id="stepSuccess" class="step-content hidden text-center pt-10">
                    <h2 class="text-2xl font-bold text-gray-700">é ç´„æˆåŠŸï¼</h2>
                    <button onclick="liff.closeWindow()" class="mt-8 px-8 py-3 bg-gray-800 text-white rounded-xl font-bold">é—œé–‰</button>
                </div>
            </main>
        </div>

        <div id="myBookingView" class="hidden px-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-gray-700 border-l-4 border-[#8F2C2F] pl-3">æˆ‘çš„é ç´„ç´€éŒ„</h2>
                <button onclick="closeMyBookings()" class="text-sm text-gray-500 font-bold px-3 py-1 border rounded-lg">é—œé–‰</button>
            </div>
            <div id="myBookingList" class="space-y-3 pb-8"></div>
        </div>

    </div>

    <script>
        // âš ï¸ æ‚¨çš„è¨­å®šå®Œå…¨ä¿ç•™ âš ï¸
        const LIFF_ID = "2008742455-ONoideFs"; 
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxMVkhHp1PnQ_0itk4gKDfP7a5VJP7NCKKIuLH98N_ZCJnc87MRnSQu3zEej-4xoyI/exec";

        const SHOP_CONFIG = { closedWeekday: 3, holidays: ["2026-01-01"], stylistLeaves: {'s1':[],'s2':[],'s3':[]} };
        const CATEGORIES = [ {id:'hand',name:'æ‰‹éƒ¨å…‰ç™‚',icon:'ğŸ’…'}, {id:'foot',name:'è¶³éƒ¨å…‰ç™‚',icon:'ğŸ¦¶'}, {id:'remove',name:'å¸ç”²',icon:'âœ¨'}, {id:'care',name:'ä¿é¤Š',icon:'ğŸŒ¿'} ];
        
        const SERVICES = [
          // æ‰‹éƒ¨ Hand
          { category: 'hand', id: 'h1', name: 'ã€æ‰‹éƒ¨ã€‘å–®è‰²/è·³è‰²', price: 500, time: 60 },
          { category: 'hand', id: 'h2', name: 'ã€æ‰‹éƒ¨ã€‘ç›¸ç°¿ $600 æ¬¾', price: 600, time: 60 },
          { category: 'hand', id: 'h3', name: 'ã€æ‰‹éƒ¨ã€‘ç›¸ç°¿ $700 æ¬¾', price: 700, time: 60 },
          { category: 'hand', id: 'h4', name: 'ã€æ‰‹éƒ¨ã€‘å–®è‰²/è·³è‰²/çºŒä½œå¸ç”²', price: 500, time: 60 },
          { category: 'hand', id: 'h5', name: 'ã€æ‰‹éƒ¨ã€‘ç›¸ç°¿ $600 æ¬¾/çºŒä½œå¸ç”²', price: 600, time: 60 },
          { category: 'hand', id: 'h6', name: 'ã€æ‰‹éƒ¨ã€‘ç›¸ç°¿ $700 æ¬¾/çºŒä½œå¸ç”²', price: 700, time: 60 },
          { category: 'hand', id: 'h7', name: 'ã€æ‰‹éƒ¨ã€‘æ³•å¼/è‡ªå¸¶åœ–', price: 'ä¾lineç§è¨Šå ±åƒ¹', time: 90 },
          { category: 'hand', id: 'h8', name: 'ã€æ‰‹éƒ¨ã€‘å…‰ç™‚/ä¿é¤Š', price: 800, time: 90 },
          { category: 'hand', id: 'h9', name: 'ã€æ‰‹éƒ¨ã€‘ç›¸ç°¿600/ä¿é¤Š', price: 900, time: 90 },
          { category: 'hand', id: 'h10', name: 'ã€æ‰‹éƒ¨ã€‘ç›¸ç°¿700/ä¿é¤Š', price: 1000, time: 90 },
          { category: 'hand', id: 'h11', name: 'ã€æ‰‹éƒ¨ã€‘æ³•å¼/è‡ªå¸¶åœ–/ä¿é¤Š', price: 'ä¾lineç§è¨Šå ±åƒ¹', time: 120 },
          { category: 'hand', id: 'h12', name: 'ã€æ‰‹éƒ¨ã€‘ç”²ç‰‡å»¶ç”² (10æŒ‡)', price: 1000, time: 60 },
          { category: 'hand', id: 'h13', name: 'ã€æ‰‹éƒ¨ã€‘ç”²ç‰‡å»¶ç”² (5æŒ‡å…§)', price: 500, time: 30 },
          
          // è¶³éƒ¨ Foot
          { category: 'foot', id: 'f1', name: 'ã€è¶³éƒ¨ã€‘å–®è‰²/è·³è‰²', price: 500, time: 60 },
          { category: 'foot', id: 'f2', name: 'ã€è¶³éƒ¨ã€‘ç›¸ç°¿ $600 æ¬¾', price: 600, time: 60 },
          { category: 'foot', id: 'f3', name: 'ã€è¶³éƒ¨ã€‘ç›¸ç°¿ $700 æ¬¾', price: 700, time: 60 },
          { category: 'foot', id: 'f4', name: 'ã€è¶³éƒ¨ã€‘æ³•å¼/è‡ªå¸¶åœ–', price: 'ä¾lineç§è¨Šå ±åƒ¹', time: 90 },
          { category: 'foot', id: 'f1', name: 'ã€è¶³éƒ¨ã€‘å–®è‰²/è·³è‰²/çºŒä½œå¸ç”²', price: 500, time: 60 },
          { category: 'foot', id: 'f2', name: 'ã€è¶³éƒ¨ã€‘ç›¸ç°¿ $600 æ¬¾/çºŒä½œå¸ç”²', price: 600, time: 60 },
          { category: 'foot', id: 'f3', name: 'ã€è¶³éƒ¨ã€‘ç›¸ç°¿ $700 æ¬¾/çºŒä½œå¸ç”²', price: 700, time: 60 },
          { category: 'foot', id: 'f5', name: 'ã€è¶³éƒ¨ã€‘å…‰ç™‚/ä¿é¤Š', price: 1100, time: 90 },
          { category: 'foot', id: 'f6', name: 'ã€è¶³éƒ¨ã€‘ç›¸ç°¿600/ä¿é¤Š', price: 1200, time: 90 },
          { category: 'foot', id: 'f7', name: 'ã€è¶³éƒ¨ã€‘ç›¸ç°¿700/ä¿é¤Š', price: 1300, time: 90 },

          // å¸ç”² Remove
          { category: 'remove', id: 'r1', name: 'ã€å¸ç”²ã€‘æ‰‹/è¶³å–®å¸ç”²', price: 300, time: 30 },
          { category: 'remove', id: 'r2', name: 'ã€å¸ç”²ã€‘å»¶ç”²å¸ç”²', price: 400, time: 60 },
          { category: 'remove', id: 'r3', name: 'ã€çµ„åˆã€‘å…‰ç™‚å–®è‰²/å¸ç”²(è¶…éä¸‰å‘¨æˆ–æ–°å®¢)', price: 800, time: 60 },
          { category: 'remove', id: 'r4', name: 'ã€çµ„åˆã€‘ç›¸ç°¿600/å¸ç”²(è¶…éä¸‰å‘¨æˆ–æ–°å®¢)', price: 900, time: 60 },
          { category: 'remove', id: 'r5', name: 'ã€çµ„åˆã€‘ç›¸ç°¿700/å¸ç”²(è¶…éä¸‰å‘¨æˆ–æ–°å®¢)', price: 1100, time: 60 },
          { category: 'remove', id: 'r3', name: 'ã€çµ„åˆã€‘å…‰ç™‚å–®è‰²/å¸ç”²(è¶…éä¸‰å‘¨æˆ–æ–°å®¢)/ä¿é¤Š', price: 1400, time: 90 },
          { category: 'remove', id: 'r4', name: 'ã€çµ„åˆã€‘ç›¸ç°¿600/å¸ç”²(è¶…éä¸‰å‘¨æˆ–æ–°å®¢)/ä¿é¤Š', price: 1500, time: 90 },
          { category: 'remove', id: 'r5', name: 'ã€çµ„åˆã€‘ç›¸ç°¿700/å¸ç”²(è¶…éä¸‰å‘¨æˆ–æ–°å®¢)/ä¿é¤Š', price: 1600, time: 90 },
          { category: 'remove', id: 'r6', name: 'ã€çµ„åˆã€‘æ³•å¼/è‡ªå¸¶åœ–(è¶…éä¸‰å‘¨æˆ–æ–°å®¢)/ä¿é¤Š', price: 'ä¾lineç§è¨Šå ±åƒ¹', time: 120 },

          // ä¿é¤Š Care
          { category: 'care', id: 'c1', name: 'ã€ä¿é¤Šã€‘æ‰‹éƒ¨ä¿é¤Š', price: 300, time: 30 },
          { category: 'care', id: 'c2', name: 'ã€ä¿é¤Šã€‘è¶³éƒ¨ä¿®é¤Š', price: 600, time: 30 }
        ];

        const STYLISTS = [ 
            { id: 'any', name: 'ä¸æŒ‡å®šè¨­è¨ˆå¸«', img: '' },
            { id: 's1', name: 'è™¹', img: 'https://karenlii770519-cr.github.io/card/p1.jpg' }, 
            { id: 's2', name: 'æ•¬', img: 'https://karenlii770519-cr.github.io/card/p2.jpg' }, 
            { id: 's3', name: 'èŠ®ç¶º', img: 'https://karenlii770519-cr.github.io/card/p3.jpg' } 
        ];

        let currentData = { category:null, service:null, stylist:STYLISTS[0], date:'', time:null, durationSlots: 1, phone:'', userId:'', userImg:'' };
        let bookedTimes = []; 

        // éåŒæ­¥æ¥µé€Ÿè¼‰å…¥
        window.onload = function() {
            renderCategories(); 
            renderStylists(); 
            
            const dateInput = document.getElementById('dateInput');
            dateInput.min = new Date().toISOString().split('T')[0];
            dateInput.addEventListener('change', (e) => handleDateOrStylistChange());

            // é—œé–‰ Loading (æ·¡å‡º)
            const loadingEl = document.getElementById('loading');
            loadingEl.classList.add('fade-out');
            document.getElementById('app').classList.remove('hidden');

            // èƒŒæ™¯é€£ç·š LIFF
            initLiffInBackground();
        };

        async function initLiffInBackground() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    const nameEl = document.getElementById('userName');
                    if(nameEl) nameEl.innerText = profile.displayName;
                    const imgEl = document.getElementById('userImg');
                    if(imgEl && profile.pictureUrl) imgEl.src = profile.pictureUrl;
                    currentData.userId = profile.userId;
                }
            } catch (err) {
                console.error("LIFF èƒŒæ™¯é€£ç·šå¤±æ•—", err);
            }
        }

        // --- åŠŸèƒ½é‚è¼¯ ---
        async function showMyBookings() {
            if (!currentData.userId) {
                alert("ç³»çµ±æ­£åœ¨è®€å–æ‚¨çš„æœƒå“¡è³‡æ–™ï¼Œè«‹ç¨ç­‰ 2 ç§’å¾Œå†è©¦ä¸€æ¬¡ ğŸ™");
                return;
            }
            document.getElementById('mainView').classList.add('hidden');
            document.getElementById('myBookingView').classList.remove('hidden');
            const listDiv = document.getElementById('myBookingList');
            listDiv.innerHTML = '<p class="text-center text-gray-400 mt-10">è³‡æ–™è¼‰å…¥ä¸­...</p>';
            try {
                const res = await fetch(`${GAS_URL}?action=get_history&userId=${currentData.userId}`);
                const bookings = await res.json();
                if(bookings.length === 0) { listDiv.innerHTML = '<p class="text-center text-gray-400 mt-10">ç›®å‰æ²’æœ‰é ç´„ç´€éŒ„</p>'; return; }
                const now = new Date();
                listDiv.innerHTML = bookings.map(b => {
                    const apptTime = new Date(`${b.date}T${b.time}`);
                    const diffHours = (apptTime - now) / (1000 * 60 * 60);
                    const canCancel = diffHours > 24;
                    return `<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100"><div class="flex justify-between items-start mb-2"><div><div class="text-lg font-bold text-gray-700">${b.date} ${b.time}</div><div class="text-sm text-[#ea5548] font-bold">${b.service}</div></div><div class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500">${b.stylist}</div></div><div class="flex justify-between items-center mt-3"><span class="text-xs text-gray-400">è²»ç”¨: ${typeof b.price==='number'?'$'+b.price:b.price}</span>${canCancel ? `<button onclick="cancelBooking('${b.date}', '${b.time}')" class="px-4 py-2 bg-red-100 text-red-600 rounded-lg text-xs font-bold hover:bg-red-200">å–æ¶ˆé ç´„</button>` : `<button disabled class="px-4 py-2 bg-gray-100 text-gray-400 rounded-lg text-xs font-bold cursor-not-allowed">é™é›»è©±å–æ¶ˆ</button>`}</div></div>`;
                }).join('');
            } catch (e) { listDiv.innerHTML = '<p class="text-center text-red-400 mt-10">è¼‰å…¥å¤±æ•—</p>'; alert(e); }
        }
        function closeMyBookings() { document.getElementById('myBookingView').classList.add('hidden'); document.getElementById('mainView').classList.remove('hidden'); }
        async function cancelBooking(date, time) {
            if(!confirm(`ç¢ºå®šè¦å–æ¶ˆ ${date} ${time} çš„é ç´„å—ï¼Ÿ`)) return;
            const listDiv = document.getElementById('myBookingList'); listDiv.innerHTML = '<p class="text-center text-gray-400 mt-10">è™•ç†ä¸­...</p>';
            try { await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'cancel', userId: currentData.userId, date: date, time: time }) }); alert("é ç´„å·²å–æ¶ˆï¼"); showMyBookings(); } catch(e) { alert("å–æ¶ˆå¤±æ•—: " + e); showMyBookings(); }
        }
        async function handleDateOrStylistChange() {
            const dateStr = document.getElementById('dateInput').value; currentData.date = dateStr; if (!dateStr) return;
            document.getElementById('timeLoading').classList.remove('hidden'); document.querySelectorAll('#timeSlots button').forEach(b => b.disabled = true);
            try { const response = await fetch(`${GAS_URL}?date=${dateStr}&stylist=${currentData.stylist.name}`); bookedTimes = await response.json(); } catch (e) { bookedTimes = []; } finally { document.getElementById('timeLoading').classList.add('hidden'); renderTimeSlots(); }
        }
        
        function renderTimeSlots() {
            const times = [
                '11:00', '11:30', '12:00', '12:30', '13:00', '13:30',
                '14:00', '14:30', '15:00', '15:30', '16:00', '16:30',
                '17:00', '17:30', '18:00', '18:30', '19:00'
            ];
            
            let requiredSlots = 1;
            if (currentData.service) {
                requiredSlots = Math.ceil(currentData.service.time / 30);
            }
            currentData.durationSlots = requiredSlots;

            if (currentData.service) {
                document.getElementById('durationHint').innerText = `(éœ€ ${currentData.service.time} åˆ†é˜)`;
            } else {
                document.getElementById('durationHint').innerText = "";
            }

            document.getElementById('timeSlots').innerHTML = times.map((t, index) => {
                let isBooked = bookedTimes.includes(t); 
                let isAvailable = !isBooked;

                if (isAvailable && requiredSlots > 1) { 
                    for (let i = 1; i < requiredSlots; i++) { 
                        if (index + i >= times.length || bookedTimes.includes(times[index + i])) { 
                            isAvailable = false; 
                            break; 
                        } 
                    } 
                }
                
                return `<button onclick="selectTime('${t}', ${index})" id="time-${index}" ${!isAvailable ? 'disabled' : ''} class="py-2 border border-gray-200 rounded-lg text-sm font-bold bg-white ${!isAvailable ? 'btn-disabled' : 'text-gray-500 hover:border-[#ea5548]'}">${t}</button>`;
            }).join('');
        }

        function selectTime(startTime, startIndex) {
            const times = [
                '11:00', '11:30', '12:00', '12:30', '13:00', '13:30',
                '14:00', '14:30', '15:00', '15:30', '16:00', '16:30',
                '17:00', '17:30', '18:00', '18:30', '19:00'
            ];
            document.querySelectorAll('#timeSlots button').forEach(b => { if(!b.disabled) b.className = "py-2 border border-gray-200 rounded-lg text-sm font-bold bg-white text-gray-500"; });
            let selectedSlots = []; for (let i = 0; i < currentData.durationSlots; i++) { let btn = document.getElementById(`time-${startIndex + i}`); if(btn) { btn.className = "py-2 border border-[#ea5548] rounded-lg text-sm font-bold bg-[#ea5548] text-white"; selectedSlots.push(times[startIndex + i]); } }
            currentData.time = selectedSlots.join(",");
        }

        function renderCategories() { document.getElementById('categoryList').innerHTML = CATEGORIES.map(c => `<div onclick="selectCategory('${c.id}')" class="p-4 border rounded-xl text-center cursor-pointer hover:border-[#ea5548]">${c.icon} ${c.name}</div>`).join(''); }
        function selectCategory(id) { const filtered = SERVICES.filter(s => s.category === id); document.getElementById('serviceList').innerHTML = filtered.map(s => `<div onclick="selectService('${s.id}')" class="p-4 border rounded-xl flex justify-between cursor-pointer hover:border-[#ea5548]"><span>${s.name}</span><span class="text-[#8F2C2F]">${typeof s.price==='number'?'$'+s.price:s.price}</span></div>`).join(''); changeStep(2); }
        function selectService(id) { currentData.service = SERVICES.find(s => s.id === id); changeStep(3); }
        function renderStylists() { 
            document.getElementById('stylistList').innerHTML = STYLISTS.map(s => `
                <div onclick="selectStylist('${s.id}')" class="p-3 border rounded-xl flex items-center gap-3 cursor-pointer hover:border-[#ea5548]">
                    <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden border border-gray-100">
                        ${s.img ? `<img src="${s.img}" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center text-[10px] text-gray-500 font-bold">ä¸æŒ‡å®š</div>'}
                    </div>
                    <div>${s.name}</div>
                </div>
            `).join(''); 
        }
        function selectStylist(id) { currentData.stylist = STYLISTS.find(s => s.id === id); if(currentData.date) handleDateOrStylistChange(); }
        function validateAndNext() { currentData.phone = document.getElementById('userPhone').value; if(!currentData.date || !currentData.time || !currentData.phone) return alert("è«‹å¡«å¯«å®Œæ•´"); changeStep(5); }
        function changeStep(step) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden')); document.getElementById(`step${step}`).classList.remove('hidden');
            if(step===5) {
                document.getElementById('confirmName').innerText = document.getElementById('userName').innerText;
                document.getElementById('confirmStylist').innerText = currentData.stylist.name;
                document.getElementById('confirmService').innerText = currentData.service.name;
                document.getElementById('confirmDuration').innerText = `ç´„ ${currentData.service.time} åˆ†é˜`;
                document.getElementById('confirmDateTime').innerText = `${currentData.date} ${currentData.time.split(",")[0]}`;
            }
        }
      async function submitBooking() {
            const btn = document.querySelector('#step5 button'); 
            btn.innerText = "æ•´ç†è³‡æ–™ä¸­...";
            btn.disabled = true; 

            const payload = {
                name: document.getElementById('userName').innerText || 'Guest',
                phone: currentData.phone,
                service: currentData.service ? currentData.service.name : 'æœªé¸æ“‡',
                stylist: currentData.stylist ? currentData.stylist.name : 'ä¸æŒ‡å®š',
                date: currentData.date,
                time: currentData.time,
                price: currentData.service ? currentData.service.price : 0,
                userId: currentData.userId || 'GUEST_NO_LIFF',
                userImg: document.getElementById('userImg').src || ''
            };

            try { 
                btn.innerText = "å‚³é€ä¸­...";
                await fetch(GAS_URL, { 
                    method: 'POST', 
                    body: JSON.stringify(payload), 
                    mode: 'no-cors', 
                    headers: {'Content-Type': 'application/json'} 
                });
                
                if (liff.isInClient() && liff.isLoggedIn()) { 
                    await liff.sendMessages([{
                        type:'text', 
                        text:`ã€é ç´„æˆåŠŸã€‘\nå§“åï¼š${payload.name}\né …ç›®ï¼š${payload.service}\nè€å¸«ï¼š${payload.stylist}\næ™‚é–“ï¼š${payload.date} ${payload.time.split(",")[0]}`
                    }]); 
                } 
                changeStep('Success'); 
            } catch(e) { 
                alert("å‚³é€éŒ¯èª¤: " + e); 
                btn.innerText = "ç¢ºèªé€å‡º";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
